---
// src/pages/admin/projects/new.astro
// Auth Check
const token = Astro.cookies.get("github_token")?.value;
if (!token) return Astro.redirect("/api/auth/login");
---

<html lang="en">
    <head>
        <title>New Project</title>
    </head>
    <body class="bg-gray-50 min-h-screen p-8 font-sans">
        <div class="max-w-3xl mx-auto bg-white p-8 rounded shadow">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">
                Create New Project
            </h1>

            <form
                method="POST"
                action="/api/admin/projects/save"
                id="new-project-form"
            >
                <input type="hidden" name="filePath" id="filePath" />

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Title</label
                    >
                    <input
                        type="text"
                        name="title"
                        id="title"
                        required
                        placeholder="e.g. Solar Installation at Zomba"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                    />
                </div>

                <div class="mb-4 text-sm text-gray-500">
                    Will be saved as: <code id="filename-preview"
                        >src/content/projects/...</code
                    >
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Sort Order</label
                    >
                    <input
                        type="number"
                        name="sortOrder"
                        value="10"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                    />
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Project Images</label
                    >

                    <input type="hidden" name="images" id="images-input" />

                    <div
                        class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-50 transition text-center"
                        id="drop-zone"
                    >
                        <input
                            type="file"
                            id="file-uploader"
                            multiple
                            accept="image/*"
                            class="hidden"
                        />
                        <label for="file-uploader" class="cursor-pointer">
                            <div class="text-blue-600 font-semibold">
                                Click to upload
                            </div>
                            <p class="text-xs text-gray-500">
                                or drag and drop images here
                            </p>
                        </label>
                    </div>

                    <div id="preview-grid" class="grid grid-cols-3 gap-4 mt-4">
                    </div>

                    <p
                        id="upload-status"
                        class="text-xs text-gray-500 mt-2 h-4"
                    >
                    </p>
                </div>

                <script>
                    const fileInput = document.getElementById("file-uploader");
                    const hiddenInput = document.getElementById("images-input");
                    const previewGrid = document.getElementById("preview-grid");
                    const form = document.querySelector("form");

                    // We store the actual File objects to upload later
                    let filesToUpload = [];
                    // We store existing URLs (for the Edit page)
                    let existingUrls = (hiddenInput.value || "")
                        .split(",")
                        .map((s) => s.trim())
                        .filter(Boolean);

                    function updateUI() {
                        previewGrid.innerHTML = "";

                        // Show existing images
                        existingUrls.forEach((url, index) => {
                            renderThumbnail(url, () => {
                                existingUrls.splice(index, 1);
                                updateUI();
                            });
                        });

                        // Show new local images
                        filesToUpload.forEach((fileObj, index) => {
                            const localUrl = URL.createObjectURL(fileObj);
                            renderThumbnail(localUrl, () => {
                                filesToUpload.splice(index, 1);
                                updateUI();
                            });
                        });

                        // Update the hidden input with existing URLs (new ones aren't URLs yet)
                        hiddenInput.value = existingUrls.join(", ");
                    }

                    function renderThumbnail(url, onRemove) {
                        const div = document.createElement("div");
                        div.className =
                            "relative group aspect-square bg-gray-100 rounded border overflow-hidden";
                        div.innerHTML = `
      <img src="${url}" class="w-full h-full object-cover" />
      <button type="button" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow">âœ•</button>
    `;
                        div.querySelector("button").onclick = onRemove;
                        previewGrid.appendChild(div);
                    }

                    fileInput.addEventListener("change", (e) => {
                        const files = Array.from(e.target.files);
                        filesToUpload = [...filesToUpload, ...files];
                        updateUI();
                        fileInput.value = ""; // Reset input
                    });

                    // THE MAGIC: Intercept the form submission
                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const submitBtn = form.querySelector(
                            'button[type="submit"]',
                        );
                        submitBtn.textContent = "Uploading...";
                        submitBtn.disabled = true;

                        // 1. Upload new images one by one
                        const uploadedUrls = [];
                        for (const file of filesToUpload) {
                            const formData = new FormData();
                            formData.append("file", file);

                            const res = await fetch("/api/admin/upload", {
                                method: "POST",
                                body: formData,
                            });
                            const data = await res.json();
                            if (data.success) uploadedUrls.push(data.url);
                        }

                        // 2. Add new URLs to the hidden input
                        const finalImages = [...existingUrls, ...uploadedUrls];
                        hiddenInput.value = finalImages.join(", ");

                        // 3. Now actually submit the form to the Save API
                        form.submit();
                    });
                </script>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Description</label
                    >
                    <textarea
                        name="body"
                        rows="10"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline font-mono"
                    ></textarea>
                </div>

                <button
                    type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Create Project
                </button>
            </form>
        </div>

        <script>
            // Simple script to auto-generate the filename from the title
            const titleInput = document.getElementById("title");
            const fileInput = document.getElementById("filePath");
            const preview = document.getElementById("filename-preview");

            titleInput.addEventListener("input", (e) => {
                // Convert "My New Project" -> "my-new-project"
                const slug = e.target.value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, "-") // Replace non-alphanumeric with dashes
                    .replace(/(^-|-$)+/g, ""); // Remove leading/trailing dashes

                const path = `src/content/projects/${slug}.md`;
                fileInput.value = path;
                preview.textContent = path;
            });
        </script>
    </body>
</html>
