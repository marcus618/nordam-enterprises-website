---
// src/pages/admin/index.astro
import { Octokit } from "octokit";

// 1. Check for the session cookie
const token = Astro.cookies.get("github_token")?.value;

// 2. If no token, redirect to login
if (!token) {
  return Astro.redirect("/api/auth/login");
}

// 3. Initialize Octokit (GitHub SDK) with the user's token
const octokit = new Octokit({ auth: token });

let user;
try {
  // 4. Fetch the current user's profile to verify the token works
  const { data } = await octokit.rest.users.getAuthenticated();
  user = data;
} catch (error) {
  // If the token is invalid (e.g., revoked), clear it and redirect
  Astro.cookies.delete("github_token", { path: "/" });
  return Astro.redirect("/api/auth/login");
}
---

<html lang="en">
  <head>
    <title>Admin Dashboard</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
  </head>
  <body class="bg-gray-100 min-h-screen p-8 font-sans">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
      <div class="flex items-center justify-between mb-8 border-b pb-4">
        <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
        <div class="flex items-center gap-4">
          <span class="text-sm text-gray-600">Logged in as <strong>{user.login}</strong></span>
          <img src={user.avatar_url} alt="Profile" class="w-10 h-10 rounded-full border" />
          <form method="POST" action="/api/auth/logout">
            <button class="text-sm text-red-600 hover:text-red-800 underline">Logout</button>
          </form>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <a href="/admin/services" class="block p-6 bg-blue-50 border border-blue-100 rounded-lg hover:shadow-lg transition">
          <h2 class="text-xl font-semibold text-blue-800 mb-2">Services</h2>
          <p class="text-gray-600 text-sm">Manage your service offerings.</p>
        </a>

        <a href="/admin/products" class="block p-6 bg-green-50 border border-green-100 rounded-lg hover:shadow-lg transition">
          <h2 class="text-xl font-semibold text-green-800 mb-2">Products</h2>
          <p class="text-gray-600 text-sm">Edit product details and prices.</p>
        </a>

        <a href="/admin/projects" class="block p-6 bg-purple-50 border border-purple-100 rounded-lg hover:shadow-lg transition">
          <h2 class="text-xl font-semibold text-purple-800 mb-2">Projects</h2>
          <p class="text-gray-600 text-sm">Update your project portfolio.</p>
        </a>
      </div>
    </div>
  </body>
</html>