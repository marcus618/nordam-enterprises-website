---
import { Octokit } from "octokit";

// 1. Auth Check
const token = Astro.cookies.get("github_token")?.value;
if (!token) return Astro.redirect("/api/auth/login");

const octokit = new Octokit({ auth: token });
const owner = import.meta.env.REPO_OWNER;
const repo = import.meta.env.REPO_NAME;

// 2. Fetch the list of files in the "products" folder
let files = [];
let error = null;

try {
    const response = await octokit.rest.repos.getContent({
        owner,
        repo,
        path: "src/content/products",
    });

    if (Array.isArray(response.data)) {
        files = response.data.filter(
            (file) => file.name.endsWith(".md") || file.name.endsWith(".mdx"),
        );
    }
} catch (e) {
    if (e.status !== 404) {
        error = e.message;
    }
}
---

<html lang="en">
    <head>
        <title>Manage Products</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 min-h-screen p-8 font-sans">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-8">
                <div>
                    <a
                        href="/admin"
                        class="text-blue-600 hover:underline mb-2 block"
                        >&larr; Back to Dashboard</a
                    >
                    <h1 class="text-3xl font-bold text-gray-900">Products</h1>
                </div>
                <a
                    href="/admin/products/new"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
                >
                    + New Product
                </a>
            </div>

            {
                error && (
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                        Error loading products: {error}
                    </div>
                )
            }

            <div class="bg-white shadow rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >Filename</th
                            >
                            <th
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider"
                                >Actions</th
                            >
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {
                            files.length === 0 ? (
                                <tr>
                                    <td
                                        colspan="2"
                                        class="px-6 py-4 text-center text-gray-500"
                                    >
                                        No products found. Click "New Product"
                                        to create one.
                                    </td>
                                </tr>
                            ) : (
                                files.map((file) => (
                                    <tr class="hover:bg-gray-50 transition-opacity duration-300" id={`row-${file.sha}`}>
  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
    <div class="flex items-center gap-3">
      <span class="file-name">{file.name}</span>
      <div class="hidden delete-spinner animate-spin h-4 w-4 border-2 border-blue-600 border-t-transparent rounded-full"></div>
    </div>
  </td>
  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
    <div class="flex justify-end gap-4 actions-area">
      <a href={`/admin/products/edit/${file.name}`} class="text-indigo-600 hover:text-indigo-900">Edit</a>
      
      <button 
        type="button" 
        class="text-red-600 hover:text-red-900 delete-btn"
        data-path={file.path}
        data-sha={file.sha}
      >
        Delete
      </button>
    </div>
  </td>
</tr>

<script>
  // Handle deletions via AJAX instead of standard form submission
  const deleteButtons = document.querySelectorAll('.delete-btn');

  deleteButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const path = btn.getAttribute('data-path');
      const sha = btn.getAttribute('data-sha');
      const row = document.getElementById(`row-${sha}`);
      const spinner = row.querySelector('.delete-spinner');
      const actions = row.querySelector('.actions-area');

      if (!confirm(`Are you sure you want to delete ${path}?`)) return;

      // 1. Enter "Loading" state
      btn.disabled = true;
      spinner.classList.remove('hidden');
      actions.classList.add('opacity-50', 'pointer-events-none');
      row.classList.add('bg-red-50');

      // 2. Send the request to the API
      const formData = new FormData();
      formData.append('filePath', path);
      formData.append('sha', sha);
      formData.append('collection', 'products');

      try {
        const response = await fetch('/api/admin/delete', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          // 3. Success: Remove the row from the UI
          row.style.opacity = '0';
          setTimeout(() => row.remove(), 300);
        } else {
          throw new Error('Deletion failed');
        }
      } catch (err) {
        alert("Failed to delete the product. Please try again.");
        // Reset UI on error
        spinner.classList.add('hidden');
        actions.classList.remove('opacity-50', 'pointer-events-none');
        row.classList.remove('bg-red-50');
      }
    });
  });
</script>
                                ))
                            )
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </body>
</html>