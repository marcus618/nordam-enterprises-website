---
const token = Astro.cookies.get("github_token")?.value;
if (!token) return Astro.redirect("/api/auth/login");
---

<html lang="en">
    <head>
        <title>New Product</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 min-h-screen p-8 font-sans">
        <div class="max-w-3xl mx-auto bg-white p-8 rounded shadow">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">
                Create New Product
            </h1>

            <form method="POST" action="/api/admin/save" id="new-product-form">
                <input type="hidden" name="filePath" id="filePath" />
                <input type="hidden" name="collection" value="products" />

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Title</label
                    >
                    <input
                        type="text"
                        name="title"
                        id="title"
                        required
                        placeholder="e.g. Generator Maintenance"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                    />
                </div>

                <div class="mb-4 text-sm text-gray-500">
                    Will be saved as: <code id="filename-preview"
                        >src/content/products/...</code
                    >
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Sort Order</label
                    >
                    <input
                        type="number"
                        name="sortOrder"
                        value="10"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                    />
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Product Image</label
                    >

                    <input type="hidden" name="image" id="image-input" />

                    <div
                        class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-50 transition text-center"
                        id="drop-zone"
                    >
                        <input
                            type="file"
                            id="file-uploader"
                            accept="image/*"
                            class="hidden"
                        />
                        <label for="file-uploader" class="cursor-pointer">
                            <div class="text-blue-600 font-semibold">
                                Click to upload
                            </div>
                            <p class="text-xs text-gray-500">
                                or drag and drop an image here
                            </p>
                        </label>
                    </div>

                    <div id="preview-grid" class="grid grid-cols-3 gap-4 mt-4">
                    </div>

                    <p
                        id="upload-status"
                        class="text-xs text-gray-500 mt-2 h-4"
                    >
                    </p>
                </div>

                <script>
                    const fileInput = document.getElementById("file-uploader");
                    const hiddenInput = document.getElementById("image-input");
                    const previewGrid = document.getElementById("preview-grid");
                    const form = document.querySelector("form");
                    let fileToUpload = null;
                    let existingUrl = "";

                    function updateUI() {
                        previewGrid.innerHTML = "";
                        if (existingUrl) {
                            renderThumbnail(existingUrl, () => {
                                existingUrl = "";
                                hiddenInput.value = "";
                                updateUI();
                            });
                        }
                        if (fileToUpload) {
                            const localUrl = URL.createObjectURL(fileToUpload);
                            renderThumbnail(localUrl, () => {
                                fileToUpload = null;
                                updateUI();
                            });
                        }
                    }

                    function renderThumbnail(url, onRemove) {
                        const div = document.createElement("div");
                        div.className =
                            "relative group aspect-square bg-gray-100 rounded border overflow-hidden";
                        div.innerHTML = `
      <img src="${url}" class="w-full h-full object-cover" />
      <button type="button" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow">âœ•</button>
    `;
                        div.querySelector("button").onclick = onRemove;
                        previewGrid.appendChild(div);
                    }

                    fileInput.addEventListener("change", (e) => {
                        const files = Array.from(e.target.files);
                        fileToUpload = files[0] || null;
                        updateUI();
                        fileInput.value = ""; // Reset input
                    });

                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const submitBtn = form.querySelector(
                            'button[type="submit"]',
                        );
                        submitBtn.textContent = "Uploading...";
                        submitBtn.disabled = true;

                        // 1. Upload new image if present
                        let uploadedUrl = "";
                        if (fileToUpload) {
                            const formData = new FormData();
                            formData.append("file", fileToUpload);

                            const res = await fetch("/api/admin/upload", {
                                method: "POST",
                                body: formData,
                            });
                            const data = await res.json();
                            if (data.success) uploadedUrl = data.url;
                        }

                        // 2. Set the hidden input
                        hiddenInput.value = uploadedUrl || existingUrl;

                        // 3. Prevent submit if no image
                        if (!hiddenInput.value) {
                            alert("Please upload an image for this product.");
                            submitBtn.textContent = "Create Product";
                            submitBtn.disabled = false;
                            return;
                        }

                        // 4. Now actually submit the form to the Save API
                        form.submit();
                    });
                </script>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Description</label
                    >
                    <textarea
                        name="body"
                        rows="10"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline font-mono"
                    ></textarea>
                </div>

                <button
                    type="submit"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                >
                    Create Product
                </button>
            </form>
        </div>

        <script>
            // Auto-generate the filename from the title
            const titleInput = document.getElementById("title");
            const fileInputPath = document.getElementById("filePath");
            const preview = document.getElementById("filename-preview");

            titleInput.addEventListener("input", (e) => {
                const slug = e.target.value
                    .toLowerCase()
                    .replace(/[^a-z0-9]+/g, "-")
                    .replace(/(^-|-$)+/g, "");
                const path = `src/content/products/${slug}.md`;
                fileInputPath.value = path;
                preview.textContent = path;
            });
        </script>
    </body>
</html>
