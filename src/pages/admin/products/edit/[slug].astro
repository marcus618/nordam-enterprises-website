---
import { Octokit } from "octokit";
import matter from "gray-matter";

// 1. Auth Check
const token = Astro.cookies.get("github_token")?.value;
if (!token) return Astro.redirect("/api/auth/login");

const { slug } = Astro.params;
const owner = import.meta.env.REPO_OWNER;
const repo = import.meta.env.REPO_NAME;
const path = `src/content/products/${slug}`;

const octokit = new Octokit({ auth: token });
let fileContent = "";
let sha = "";
let frontmatter = {};
let markdownBody = "";

try {
    // 2. Fetch the file from GitHub
    const { data } = await octokit.rest.repos.getContent({
        owner,
        repo,
        path,
    });

    // 3. Decode content (GitHub sends Base64)
    if (!Array.isArray(data) && data.content) {
        fileContent = Buffer.from(data.content, "base64").toString("utf-8");
        sha = data.sha;

        // 4. Parse Frontmatter vs Body
        const parsed = matter(fileContent);
        frontmatter = parsed.data; // { title: '...', image: '...', sortOrder: 1 }
        markdownBody = parsed.content;
    }
} catch (e) {
    return new Response("File not found", { status: 404 });
}

const imageUrl = typeof frontmatter.image === "string" ? frontmatter.image : "";
---

<html lang="en">
    <head>
        <title>Edit Product: {slug}</title>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 min-h-screen p-8 font-sans">
        <div class="max-w-3xl mx-auto bg-white p-8 rounded shadow">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Edit Product</h1>
                <a
                    href="/admin/products"
                    class="text-sm text-gray-500 hover:text-gray-800">Cancel</a
                >
            </div>

            <form method="POST" action="/api/admin/save" id="edit-product-form">
                <input type="hidden" name="filePath" value={path} />
                <input type="hidden" name="sha" value={sha} />
                <input type="hidden" name="collection" value="products" />

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Title</label
                    >
                    <input
                        type="text"
                        name="title"
                        value={frontmatter.title}
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                        required
                    />
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Sort Order</label
                    >
                    <input
                        type="number"
                        name="sortOrder"
                        value={frontmatter.sortOrder}
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                    />
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Product Image</label
                    >
                    <input
                        type="hidden"
                        name="image"
                        id="image-input"
                        value={imageUrl}
                    />

                    <div
                        class="border-2 border-dashed border-gray-300 rounded-lg p-6 hover:bg-gray-50 transition text-center"
                        id="drop-zone"
                    >
                        <input
                            type="file"
                            id="file-uploader"
                            accept="image/*"
                            class="hidden"
                        />
                        <label for="file-uploader" class="cursor-pointer">
                            <div class="text-blue-600 font-semibold">
                                Click to upload
                            </div>
                            <p class="text-xs text-gray-500">
                                or drag and drop an image here
                            </p>
                        </label>
                    </div>

                    <div id="preview-grid" class="grid grid-cols-3 gap-4 mt-4">
                    </div>
                    <p
                        id="upload-status"
                        class="text-xs text-gray-500 mt-2 h-4"
                    >
                    </p>
                </div>

                <script>
                    const fileInput = document.getElementById("file-uploader");
                    const hiddenInput = document.getElementById("image-input");
                    const previewGrid = document.getElementById("preview-grid");
                    const form = document.getElementById("edit-product-form");
                    let fileToUpload = null;
                    let existingUrl = hiddenInput.value;

                    function updateUI() {
                        previewGrid.innerHTML = "";
                        // If there is an image (existing or uploaded), show it and disable file input
                        if (existingUrl) {
                            renderThumbnail(existingUrl, () => {
                                existingUrl = "";
                                hiddenInput.value = "";
                                updateUI();
                            });
                            fileInput.disabled = true;
                        } else if (fileToUpload) {
                            const localUrl = URL.createObjectURL(fileToUpload);
                            renderThumbnail(localUrl, () => {
                                fileToUpload = null;
                                updateUI();
                            });
                            fileInput.disabled = true;
                        } else {
                            fileInput.disabled = false;
                        }
                    }

                    function renderThumbnail(url, onRemove) {
                        const div = document.createElement("div");
                        div.className =
                            "relative group aspect-square bg-gray-100 rounded border overflow-hidden";
                        div.innerHTML = `
      <img src="${url}" class="w-full h-full object-cover" />
      <button type="button" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow">âœ•</button>
    `;
                        div.querySelector("button").onclick = onRemove;
                        previewGrid.appendChild(div);
                    }

                    fileInput.addEventListener("change", (e) => {
                        const files = Array.from(e.target.files);
                        fileToUpload = files[0] || null;
                        updateUI();
                        fileInput.value = ""; // Reset input
                    });

                    form.addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const submitBtn = form.querySelector(
                            'button[type="submit"]',
                        );
                        submitBtn.textContent = "Uploading...";
                        submitBtn.disabled = true;

                        // 1. Upload new image if present
                        let uploadedUrl = "";
                        if (fileToUpload) {
                            const formData = new FormData();
                            formData.append("file", fileToUpload);

                            const res = await fetch("/api/admin/upload", {
                                method: "POST",
                                body: formData,
                            });
                            const data = await res.json();
                            if (data.success) uploadedUrl = data.url;
                        }

                        // 2. Set the hidden input
                        hiddenInput.value = uploadedUrl || existingUrl;

                        // 3. Now actually submit the form to the Save API
                        form.submit();
                    });

                    // Initial UI update
                    updateUI();
                </script>

                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2"
                        >Description</label
                    >
                    <textarea
                        name="body"
                        rows="10"
                        class="bg-white text-gray-900 shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"
                        >{markdownBody}</textarea
                    >
                </div>

                <div class="flex items-center justify-end">
                    <button
                        type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
                    >
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </body>
</html>
