---
// src/components/admin/AdminForm.astro
const { 
  title = "", 
  sortOrder = 10, 
  images = "", 
  body = "", 
  path = "", 
  sha = "", 
  isNew = false,
  allowMultiple = false // Projects = true, Services/Products = false
} = Astro.props;

// Ensure images is an array for the UI logic
const initialImages = images ? images.split(',').map(s => s.trim()).filter(Boolean) : [];
---

<form method="POST" action="/api/admin/projects/save" class="space-y-6" id="admin-form">
  <input type="hidden" name="filePath" id="filePath" value={path} />
  <input type="hidden" name="sha" value={sha} />
  <input type="hidden" name="images" id="images-input" value={images} />

  <div>
    <label class="block text-sm font-bold text-gray-700">Title</label>
    <input type="text" name="title" id="title-input" value={title} required 
      class="mt-1 block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white text-gray-900 p-2 border" />
  </div>

  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-bold text-gray-700">Sort Order</label>
      <input type="number" name="sortOrder" value={sortOrder} 
        class="mt-1 block w-full rounded border-gray-300 shadow-sm bg-white text-gray-900 p-2 border" />
    </div>
  </div>

  <div>
    <label class="block text-sm font-bold text-gray-700">
      {allowMultiple ? "Project Images" : "Featured Image"}
    </label>
    <div class="mt-1 border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:bg-gray-50 transition" id="drop-zone">
      <input type="file" id="file-uploader" accept="image/*" class="hidden" {allowMultiple ? 'multiple' : ''} />
      <label for="file-uploader" class="cursor-pointer text-blue-600 hover:underline">
        {allowMultiple ? "Upload one or more images" : "Upload a single image"}
      </label>
    </div>
    
    <div id="preview-grid" class="grid grid-cols-3 gap-4 mt-4"></div>
    <p id="upload-status" class="text-xs text-gray-500 mt-2 h-4"></p>
  </div>

  <div>
    <label class="block text-sm font-bold text-gray-700">Description / Content</label>
    <textarea name="body" rows="10" 
      class="mt-1 block w-full rounded border-gray-300 shadow-sm font-mono bg-white text-gray-900 p-2 border">{body}</textarea>
  </div>

  <div class="flex justify-end gap-4">
    <a href="javascript:history.back()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancel</a>
    <button type="submit" id="submit-btn" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700 disabled:opacity-50">
      {isNew ? 'Create' : 'Save Changes'}
    </button>
  </div>
</form>

<script define:vars={{ initialImages, allowMultiple, isNew }}>
  const form = document.getElementById('admin-form');
  const fileInput = document.getElementById('file-uploader');
  const hiddenInput = document.getElementById('images-input');
  const previewGrid = document.getElementById('preview-grid');
  const titleInput = document.getElementById('title-input');
  const pathInput = document.getElementById('filePath');
  const status = document.getElementById('upload-status');
  const submitBtn = document.getElementById('submit-btn');

  let filesToUpload = [];
  let existingUrls = initialImages;

  // 1. Slugify Title for New Files
  if (isNew) {
    titleInput.addEventListener('input', (e) => {
      const slug = e.target.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)+/g, '');
      // We need to know if we are in projects, services, or products
      // We can guess the folder from the current URL
      const folder = window.location.pathname.split('/')[2]; 
      pathInput.value = `src/content/${folder}/${slug}.md`;
    });
  }

  function updateUI() {
    previewGrid.innerHTML = '';
    const render = (url, isLocal, index) => {
      const div = document.createElement('div');
      div.className = "relative aspect-square rounded border overflow-hidden bg-gray-100";
      div.innerHTML = `<img src="${url}" class="w-full h-full object-cover" />
        <button type="button" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">âœ•</button>`;
      div.querySelector('button').onclick = () => {
        if (isLocal) filesToUpload.splice(index, 1);
        else existingUrls.splice(index, 1);
        updateUI();
      };
      previewGrid.appendChild(div);
    };

    existingUrls.forEach((url, i) => render(url, false, i));
    filesToUpload.forEach((f, i) => render(URL.createObjectURL(f), true, i));
    
    hiddenInput.value = existingUrls.join(', ');
  }

  fileInput.addEventListener('change', (e) => {
    const selected = Array.from(e.target.files);
    if (!allowMultiple) {
      // If single image, replace everything
      filesToUpload = [selected[0]];
      existingUrls = [];
    } else {
      filesToUpload = [...filesToUpload, ...selected];
    }
    updateUI();
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = "Uploading...";

    for (const file of filesToUpload) {
      const fd = new FormData();
      fd.append('file', file);
      const res = await fetch('/api/admin/upload', { method: 'POST', body: fd });
      const data = await res.json();
      if (data.success) existingUrls.push(data.url);
    }

    hiddenInput.value = existingUrls.join(', ');
    form.submit();
  });

  updateUI();
</script>